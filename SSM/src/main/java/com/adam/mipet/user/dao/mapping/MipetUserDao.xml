<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.adam.mipet.user.dao.MipetUserDao">
	<resultMap id="BaseResultMap" type="com.adam.mipet.user.entity.MipetUser">
		<result column="ID" property="id" jdbcType="INTEGER" />
		<result column="SOURCE" property="source" jdbcType="VARCHAR" />
		<result column="USERNAME" property="username" jdbcType="VARCHAR" />
		<result column="PASSWORD" property="password" jdbcType="VARCHAR" />
		<result column="NICKNAME" property="nickname" jdbcType="VARCHAR" />
		<result column="GENDER" property="gender" jdbcType="INTEGER" />
		<result column="BIRTHDAY" property="birthday" jdbcType="DATE" />
		<result column="FAMILY" property="family" jdbcType="VARCHAR" />
		<result column="HEAD_PIC" property="headPic" jdbcType="VARCHAR" />
		<result column="PHONE" property="phone" jdbcType="VARCHAR" />
		<result column="EMAIL" property="email" jdbcType="VARCHAR" />
		<result column="reg_time" property="regTime" jdbcType="DATE" />
		<result column="LOGIN_TIME" property="loginTime" jdbcType="DATE" />
		<result column="LOGIN_IP" property="loginIp" jdbcType="VARCHAR" />
		<result column="LOGIN_TIMES" property="loginTimes" jdbcType="INTEGER" />
		<result column="STATUS" property="status" jdbcType="INTEGER" />
		<result column="ENABLED" property="enabled" jdbcType="INTEGER" />
		<result column="CLIENT_ID" property="clientId" jdbcType="VARCHAR" />
		<result column="DELETED" property="deleted" jdbcType="INTEGER" />
		<result column="UPDATE_TIME" property="updateTime" jdbcType="DATE" />
	</resultMap>
	<sql id="Base_Column_List">
		id,source,username,password,nickname,gender,birthday,
		family,head_pic,phone,email,reg_time,login_time,login_ip,
		login_times,status,enabled,client_id,deleted,update_time
	</sql>
	<sql id="Base_Column_List_noPass">
		id,source,username,nickname,gender,birthday,
		family,head_pic,phone,email,reg_time,login_time,login_ip,
		login_times,status,enabled,client_id,deleted,update_time
	</sql>

	<select id="query" parameterType="map" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from user_info
		<where>
			deleted = 0
			<if test="id != null">
				and id = #{id}
			</if>
			<if test="nickname != null">
				and nickname like concat('%',#{nickname},'%')
			</if>
			<if test="phone != null">
				and phone like concat('%',#{phone},'%')
			</if>
			<if test="enabled != null and enabled != ''">
				and enabled = #{enabled}
			</if>
			<if test="status != null and status != ''">
				and status = #{status}
			</if>
		</where>
		order by reg_time desc
		<if test="start != null and rows != null and start >= 0 and rows > 0">
			limit #{start},#{rows}
		</if>
	</select>

	<select id="queryCheckRepeatPhone" parameterType="map"
		resultType="int">
		select count(1)
		from user_info where deleted = 0 and phone =
		#{phone}
	</select>

	<select id="queryLogin" resultMap="BaseResultMap" parameterType="map">
		select
		<include refid="Base_Column_List_noPass" />
		from user_info
		where deleted=0 and phone=#{phone} and password=#{password}
	</select>
	
	<select id="querybyid" resultMap="BaseResultMap" parameterType="int">
		select
		<include refid="Base_Column_List" />
		from user_info
		where deleted=0 and id=#{id}
	</select>
	
	<select id="querybyphone" resultMap="BaseResultMap" parameterType="map">
		select
		<include refid="Base_Column_List" />
		from user_info
		where deleted=0 and phone=#{phone}
	</select>

	<select id="queryCount" resultType="int" parameterType="map">
		select count(1) from user_info
		<where>
			deleted = 0
			<if test="username != null">
				and username like concat('%',#{username},'%')
			</if>
			<if test="phone != null">
				and phone like concat('%',#{phone},'%')
			</if>
			<if test="enabled != null">
				and enabled = #{enabled}
			</if>
			<if test="status != null">
				and status = #{status}
			</if>
		</where>
	</select>

	<update id="update" parameterType="com.adam.mipet.user.entity.MipetUser">
		update user_info
		<set>
			update_time = now()
				,nickname = #{nickname}
				,gender = #{gender}
				,birthday = #{birthday}
				,family = #{family}
				,head_pic = #{headPic}
			<if test="email != null and email != ''">
				,email = #{email}
			</if>
			<if test="status != null and status != ''">
				,status = #{status}
			</if>
			<if test="enabled != null">
				,enabled = #{enabled}
			</if>
		</set>
		<where>
			id = #{id}
		</where>
	</update>
	<!-- 更新用户设备ID到库 -->
	<update id="updateClientId" parameterType="com.adam.mipet.user.entity.MipetUser">
		update user_info set client_id = #{clientId} where id = #{id}
	</update>
	
	<update id="updatepwd" parameterType="com.adam.mipet.user.entity.MipetUser">
		update user_info set password=#{password}
		<where>
			<if test="id != null and id != ''">
				id=#{id}
			</if>
		</where>
	</update>
	
		<update id="updateStatus" parameterType="com.adam.mipet.user.entity.MipetUser">
		update user_info set enabled=#{enabled}
		<where>
			<if test="id != null and id != ''">
				id=#{id}
			</if>
		</where>
	</update>

	<update id="delete" parameterType="com.adam.mipet.user.entity.MipetUser">
		update user_info
		<set>
			update_time = now(),deleted = 1
		</set>
		<where>
			id = #{id}
		</where>
	</update>


	<insert id="insert" parameterType="com.adam.mipet.user.entity.MipetUser"
		useGeneratedKeys="true" keyProperty="id">
		insert into
		user_info(
		username,password,nickname,gender,birthday,
		family,head_pic,phone,email,reg_time,login_time,login_ip,
		login_times,update_time
		)values(
		#{username},#{password},#{nickname},1,#{birthday},
		#{family},#{headPic},#{phone},#{email},now(),now(),#{loginIp},
		0,now())
	</insert>


</mapper>