<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.adam.sys.userfunc.dao.MenuDao" >
  <resultMap id="BaseResultMap" type="com.adam.sys.userfunc.entity.Menu" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="url" property="url" jdbcType="VARCHAR" />
    <result column="web_url" property="webUrl" jdbcType="VARCHAR" />
    <result column="image_url" property="imageUrl" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="parent_id" property="parentId" jdbcType="INTEGER" />
    <result column="creator" property="creator" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="updator" property="updator" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="is_deleted" property="isDeleted" jdbcType="INTEGER" />
    <result column="childCount" property="childCount" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, name, parent_id, url, web_url,image_url,sort,status, creator, create_time, updator, update_time, is_deleted
  </sql>
  <!-- 获取角色已分配菜单 -->
  <select id="queryMenuY" parameterType="map" resultMap="BaseResultMap">
	select * from t_sys_menu where is_deleted=0 AND id in(
	  select menu_id from t_sys_rolemenu where is_deleted=0 AND role_id=#{roleId}
	) and parent_id=#{parentId} and status != #{status}
  </select>
  <!-- 获取角色未分配菜单 -->
  <select id="queryMenuN" parameterType="map" resultMap="BaseResultMap">
	select * from (
	select *,(SELECT COUNT(1) FROM t_sys_menu WHERE is_deleted=0 AND parent_id=T.id) childCount
	from t_sys_menu T )t1 where is_deleted=0 AND t1.parent_id=#{parentId} and t1.childCount=0 and 
	t1.id not in(select menu_id from t_sys_rolemenu where role_id=#{roleId}) and status != #{status}
	UNION ALL
	select * from (
	select *,(SELECT COUNT(1) FROM t_sys_menu WHERE is_deleted=0 AND parent_id=T.id) childCount
	from t_sys_menu T )t1 where is_deleted=0 AND t1.parent_id=#{parentId} and t1.childCount>0 and status != #{status}
  </select>
  <!-- 根据ID获取菜单名 -->
  <select id="queryNameByid" parameterType="java.lang.Integer" resultType="java.lang.String">
  	select name from t_sys_menu where parent_id = 2 and id = #{id}
  </select>
  <!-- 获取主页面用户菜单 -->
  <select id="queryMainMenu" parameterType="map" resultMap="BaseResultMap">

	select * from t_sys_menu where is_deleted=0 
	<if test="status != null">
		and status != #{status} 
	</if>
	<if test="userId!=null">
		AND id in(
			select menu_id from t_sys_rolemenu where is_deleted=0 AND role_id in(
		    	select id from t_sys_role where is_deleted=0 AND id in(
					select role_id from t_sys_userrole where is_deleted=0 AND user_id=#{userId}
			    )
			)
		) 
		
	</if>
	<if test="parentId!=null">
	  and parent_id=#{parentId} order by sort
	</if>
  </select>


	<update id="updateSortDown" parameterType="string">
		update t_sys_menu set sort=sort-1 where id=#{id}
	</update>
	<update id="updateSortUp" parameterType="string">
		update t_sys_menu set sort=sort+1 where id=#{id}
	</update>
  
  <update id="delete" parameterType="com.adam.sys.userfunc.entity.Menu" >
    update t_sys_menu set is_deleted=1 ,updator=#{updator,jdbcType=VARCHAR} where id = #{id,jdbcType=INTEGER}
  </update>
  
  <insert id="insert" parameterType="com.adam.sys.userfunc.entity.Menu" >
    insert into t_sys_menu (name, url,web_url,image_url,status, parent_id, creator, create_time,update_time,updator,is_deleted,sort)
    select #{name,jdbcType=VARCHAR}, #{url,jdbcType=VARCHAR}, #{webUrl,jdbcType=VARCHAR}, #{imageUrl,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, 
    	#{parentId,jdbcType=INTEGER},#{creator,jdbcType=VARCHAR}, NOW(),NOW(),#{creator,jdbcType=VARCHAR},0,max(sort)+1
    from t_sys_menu where parent_id = #{parentId,jdbcType=INTEGER}
  </insert>
  
  <update id="update" parameterType="com.adam.sys.userfunc.entity.Menu" >
    update t_sys_menu
    set name = #{name,jdbcType=VARCHAR},
      url = #{url,jdbcType=VARCHAR},
      web_url=#{webUrl,jdbcType=VARCHAR},
      image_url=#{imageUrl,jdbcType=VARCHAR},
      status = #{status,jdbcType=INTEGER},
      parent_id = #{parentId,jdbcType=INTEGER},
      updator = #{updator,jdbcType=VARCHAR},
      update_time = NOW()
    where id = #{id,jdbcType=INTEGER}
  </update>
  <!-- 查询下一个顺号 -->
  <select id="queryNextMenuBySort" parameterType="string" resultType="string">
		select id from (
		select  * from t_sys_menu where
		parent_id = (SELECT parent_id FROM t_sys_menu WHERE id=#{menuId}) AND
		 sort>(SELECT sort FROM t_sys_menu WHERE id=#{menuId}) order by sort
		)T LIMIT 1
	</select>
	<select id="queryPrecMenuBySort" parameterType="string" resultType="string">
		<![CDATA[
		select id from (
		select  * from t_sys_menu where
		parent_id = (SELECT parent_id FROM t_sys_menu WHERE id=#{menuId}) AND
		sort<(SELECT sort FROM t_sys_menu WHERE id=#{menuId}) order by sort DESC
		)T LIMIT 1
		]]>
	</select>
  
  <select id="queryMenuByParentId" parameterType="int" resultMap="BaseResultMap">
	select * from t_sys_menu where is_deleted=0 and parent_id=#{parentId} and status !=0  order by sort
  </select>
  
  <select id="queryParentMenuName" parameterType="int" resultType="string">
        select name from t_sys_menu WHERE is_deleted=0 and id=#{menuId}
  </select>
</mapper>